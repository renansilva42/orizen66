<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <!-- Cabeçalho mantido igual -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tarefa Diária - Orizen66</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='daily.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='header.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='footer.css') }}" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <style>
        /* Estilos adicionais para o botão remover */
        .btn-remove {
            background-color: var(--danger);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s;
        }
        
        .btn-remove:hover {
            background-color: #c82333;
        }
        
        .btn-remove i {
            margin-right: 8px;
        }
        
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="container">
        {% include 'header.html' %}

        <main class="daily-content">
            <!-- Seções do cabeçalho, progresso e mensagens flash mantidas iguais -->
            <div class="page-header">
                <h1><i class="fas fa-calendar-check"></i> Conclusão de Tarefas Diárias</h1>
                <nav class="page-nav">
                    <a href="{{ url_for('profile') }}" class="nav-link"><i class="fas fa-user"></i> Perfil</a>
                    <a href="{{ url_for('ranking') }}" class="nav-link"><i class="fas fa-trophy"></i> Classificação</a>
                    <a href="{{ url_for('logout') }}" class="nav-link"><i class="fas fa-sign-out-alt"></i> Sair</a>
                </nav>
            </div>

            {% with messages = get_flashed_messages() %}
              {% if messages %}
                <div class="flash-container">
                  {% for message in messages %}
                    <div class="flash-message">
                        <i class="fas fa-info-circle"></i>
                        <span>{{ message }}</span>
                        <button class="close-flash">&times;</button>
                    </div>
                  {% endfor %}
                </div>
              {% endif %}
            {% endwith %}

            <section class="progress-section">
                <div class="progress-header">
                    <h2><i class="fas fa-chart-line"></i> Seu Progresso</h2>
                    <div class="progress-stats">
                        <span class="progress-number">{{ completed_days }}</span> / {{ total_days }} dias concluídos
                    </div>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: {{ progress_percent }}%;">
                            <span class="progress-percentage">{{ progress_percent }}%</span>
                        </div>
                    </div>
                </div>
            </section>

            {% if selected_date %}
            <section class="daily-form-section">
                <h2>
                    {% if completion and completion.completed %}
                        <i class="fas fa-edit"></i> Editar Conclusão
                    {% else %}
                        <i class="fas fa-plus-circle"></i> Adicionar Conclusão
                    {% endif %}
                    <span class="date-badge">{{ selected_date.strftime('%d/%m/%Y') }}</span>
                </h2>
            <form method="post" enctype="multipart/form-data" action="{{ url_for('daily') }}?date={{ selected_date.strftime('%Y-%m-%d') }}" class="daily-form" id="daily-form">
                <div class="form-group">
                    <label for="comment"><i class="fas fa-comment"></i> Adicione um comentário (opcional):</label>
                    <textarea id="comment" name="comment" rows="4" placeholder="Como foi seu dia? Compartilhe seus pensamentos...">{% if completion %}{{ completion.comment }}{% endif %}</textarea>
                </div>
                
                <div class="form-group">
                    <label for="photo"><i class="fas fa-camera"></i> Envie uma foto (opcional):</label>
                    <div class="file-upload">
                        <input type="file" id="photo" name="photo" accept="image/*" class="file-input" />
                        <label for="photo" class="file-upload-label" tabindex="0" role="button" aria-label="Escolha um arquivo ou arraste-o aqui">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <span>Escolha um arquivo ou arraste-o aqui</span>
                        </label>
                        <div class="file-name"></div>
                        <div class="file-preview"></div>
                    </div>
                    
                    {% if completion and completion.photo_url %}
                        <div class="current-photo">
                            <p><i class="fas fa-image"></i> Foto atual:</p>
                            <img src="{{ completion.photo_url }}" alt="Foto atual" class="daily-photo-thumb" />
                        </div>
                    {% endif %}
                </div>
                
                <div class="action-buttons">
                    <button type="submit" class="btn-complete">
                        {% if completion and completion.completed %}
                            <i class="fas fa-save"></i> Atualizar Conclusão
                        {% else %}
                            <i class="fas fa-check-circle"></i> Marcar como Concluído
                        {% endif %}
                    </button>
                    
                    {% if completion and completion.completed %}
                    <button type="button" class="btn-remove" id="btn-remove-completion">
                        <i class="fas fa-trash-alt"></i> Remover dos Concluídos
                    </button>
                    {% endif %}
                </div>
            </form>
            </section>
            {% endif %}

            <!-- Seção da linha do tempo mantida igual -->
            <section class="daily-timeline-section">
                <h2><i class="fas fa-history"></i> Linha do Tempo de Conclusões Diárias</h2>
                
                <div class="timeline-filters">
                    <div class="timeline-view-options">
                        <button class="view-option active" data-view="grid"><i class="fas fa-th"></i></button>
                        <button class="view-option" data-view="list"><i class="fas fa-list"></i></button>
                    </div>
                    <div class="timeline-filter-options">
                        <button class="filter-option active" data-filter="all">Todos</button>
                        <button class="filter-option" data-filter="completed">Concluídos</button>
                        <button class="filter-option" data-filter="missing">Pendentes</button>
                    </div>
                </div>
                
                <div class="timeline-grid" id="timeline-container">
                    {% for day in range(total_days) %}
                        {% set day_date = (start_date + timedelta(days=day)) %}
                        {% set day_iso = day_date.strftime('%Y-%m-%d') %}
                        {# Debug output for day and date #}
                        <div>DEBUG: day={{ day }}, day_date={{ day_date }}, day_iso={{ day_iso }}</div>
                        {% set day_completion = None %}
                        {% for c in completions %}
                            {% if c.date == day_iso %}
                                {% set day_completion = c %}
                            {% endif %}
                        {% endfor %}
                        
                        <div class="daily-card {% if day_completion and day_completion.completed %}completed{% else %}missing{% endif %} {% if selected_date and day_date == selected_date %}selected{% endif %}" data-date="{{ day_iso }}">
                            <div class="card-status-indicator"></div>
                            <div class="day-header">
                                <div class="day-number">Dia {{ day + 1 }}</div>
                                <div class="day-date">{{ day_date.strftime('%d/%m/%Y') }}</div>
                                {% if day_completion and day_completion.completed %}
                                    <div class="completion-badge"><i class="fas fa-check-circle"></i></div>
                                {% endif %}
                            </div>
                        
                        {% if day_completion and day_completion.completed %}
                            <div class="completion-summary">
                                {% if day_completion.photo_url %}
                                    <div class="photo-preview">
                                        <img src="{{ day_completion.photo_url }}" alt="Foto do dia {{ day + 1 }}" class="daily-photo-thumb" />
                                    </div>
                                {% endif %}
                                {% if day_completion.comment %}
                                    <div class="comment-preview">
                                        <i class="fas fa-quote-left"></i>
                                        {{ day_completion.comment[:50] }}{% if day_completion.comment|length > 50 %}...{% endif %}
                                    </div>
                                {% endif %}
                            </div>
                        {% else %}
                            <div class="completion-summary no-completion">
                                <i class="fas fa-times-circle"></i> Não concluído
                            </div>
                        {% endif %}
                        
                        <a href="{{ url_for('daily') }}?date={{ day_iso }}" class="btn-edit">
                            {% if day_completion and day_completion.completed %}
                                <i class="fas fa-edit"></i> Editar
                            {% else %}
                                <i class="fas fa-plus"></i> Concluir
                            {% endif %}
                        </a>
                    </div>
                    {% endfor %}
                </div>
            </section>
        </main>
    </div>

    <script src="{{ url_for('static', filename='daily.js') }}"></script>
                    } else {
                        flashMessage.innerHTML = `<i class="fas fa-check-circle"></i> ${message} <button class="close-flash">×</button>`;
                    }
                    
                    flashContainer.appendChild(flashMessage);
                    
                    // Add close event
                    flashMessage.querySelector('.close-flash').addEventListener('click', function() {
                        flashMessage.remove();
                    });
                }
            }
            
            // Função para contar o número total de dias concluídos
            function countCompletedDays() {
                let count = 0;
                for (const date in completionsData) {
                    if (completionsData[date].completed) {
                        count++;
                    }
                }
                return count;
            }
            
            // Função para atualizar um card para o estado não concluído
            function updateCardToIncomplete(date) {
                const card = document.querySelector(`.daily-card[data-date="${date}"]`);
                if (card) {
                    // Atualiza classes do card
                    card.classList.remove('completed');
                    card.classList.add('missing');
                    
                    // Remove o badge de conclusão
                    const badge = card.querySelector('.completion-badge');
                    if (badge) {
                        badge.remove();
                    }
                    
                    // Atualiza o resumo da conclusão
                    let summary = card.querySelector('.completion-summary');
                    if (summary) {
                        summary.innerHTML = '<i class="fas fa-times-circle"></i> Não concluído';
                        summary.classList.add('no-completion');
                    }
                    
                    // Atualiza o botão de edição
                    const btnEdit = card.querySelector('.btn-edit');
                    if (btnEdit) {
                        btnEdit.innerHTML = '<i class="fas fa-plus"></i> Concluir';
                    }
                }
            }
            
            // Manipulador de evento para o botão "Remover dos Concluídos"
            const btnRemoveCompletion = document.getElementById('btn-remove-completion');
            if (btnRemoveCompletion) {
                btnRemoveCompletion.addEventListener('click', function(event) {
                    event.preventDefault();
                    
                    // Obtém a data atual da URL
                    const urlParams = new URLSearchParams(window.location.search);
                    const currentDate = urlParams.get('date');
                    
                    if (currentDate && completionsData[currentDate]) {
                        // Remove os dados da conclusão do objeto de completions
                        delete completionsData[currentDate];
                        
                        // Salva os dados atualizados no localStorage
                        saveCompletionsToStorage();
                        
                        // Limpa os campos do formulário
                        const commentField = document.getElementById('comment');
                        if (commentField) {
                            commentField.value = '';
                        }
                        
                        // Remove a prévia da foto atual
                        const currentPhoto = document.querySelector('.current-photo');
                        if (currentPhoto) {
                            currentPhoto.remove();
                        }
                        
                        // Atualiza o card para não concluído
                        updateCardToIncomplete(currentDate);
                        
                        // Atualiza o contador de dias concluídos
                        const completedDays = countCompletedDays();
                        const totalDays = document.querySelectorAll('.daily-card').length;
                        
                        // Atualiza a UI de progresso
                        updateProgressUI(completedDays, totalDays);
                        
                        // Envia uma requisição AJAX para o backend para atualizar os dados no servidor
                        fetch(`/daily/remove?date=${currentDate}`, {
                            method: 'POST',
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest',
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                date: currentDate
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Mostra mensagem de sucesso
                                showFlashMessage('Tarefa removida dos concluídos com sucesso!');
                                
                                // Atualiza a URL para remover o parâmetro de data
                                window.location.href = '/daily';
                            } else {
                                throw new Error('Resposta do servidor indica falha na remoção');
                            }
                        })
                        .catch(error => {
                            console.error('Erro na requisição:', error);
                            
                            // Mostra mensagem de erro
                            showFlashMessage('Erro ao remover a tarefa. Os dados foram removidos localmente, mas podem não ter sido sincronizados com o servidor.', true);
                            
                            // Mesmo com erro no servidor, mantém a interface atualizada
                            window.location.href = '/daily';
                        });
                    }
                });
            }
            
            const dailyForm = document.getElementById('daily-form');
            if (dailyForm) {
                dailyForm.addEventListener('submit', function(event) {
                    event.preventDefault();
        
                    const formData = new FormData(dailyForm);
                    const actionUrl = dailyForm.getAttribute('action');
                    
                    // Extrair a data da URL do formulário
                    const urlParams = new URLSearchParams(actionUrl.split('?')[1]);
                    const currentDate = urlParams.get('date');
        
                    fetch(actionUrl, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.completed) {
                            // Salva os dados da conclusão no objeto de completions
                            completionsData[data.date] = {
                                completed: true,
                                photo_url: data.photo_url || null,
                                comment: data.comment || null,
                                date: data.date
                            };
                            
                            // Salva os dados no localStorage
                            saveCompletionsToStorage();
                            
                            // Update the card for the day dynamically
                            const dayDate = data.date; // Assume que data.date vem no formato 'YYYY-MM-DD'
                            const comment = data.comment || '';
                            const photoUrl = data.photo_url;
        
                            // Find the card with matching date
                            const card = document.querySelector(`.daily-card[data-date="${dayDate}"]`);
                            if (card) {
                                // Update card classes
                                card.classList.remove('missing');
                                card.classList.add('completed');
        
                                // Update completion badge
                                let badge = card.querySelector('.completion-badge');
                                if (!badge) {
                                    badge = document.createElement('div');
                                    badge.classList.add('completion-badge');
                                    badge.innerHTML = '<i class="fas fa-check-circle"></i>';
                                    const dayHeader = card.querySelector('.day-header');
                                    if (dayHeader) {
                                        dayHeader.appendChild(badge);
                                    }
                                }
        
                                // Update completion summary
                                let summary = card.querySelector('.completion-summary');
                                if (!summary) {
                                    summary = document.createElement('div');
                                    summary.classList.add('completion-summary');
                                    card.insertBefore(summary, card.querySelector('.btn-edit'));
                                } else {
                                    // Limpa o conteúdo atual
                                    summary.innerHTML = '';
                                    summary.classList.remove('no-completion');
                                }
        
                                if (photoUrl) {
                                    const photoDiv = document.createElement('div');
                                    photoDiv.classList.add('photo-preview');
                                    const img = document.createElement('img');
                                    img.src = photoUrl;
                                    img.alt = `Foto do dia ${card.querySelector('.day-number').textContent}`;
                                    img.classList.add('daily-photo-thumb');
                                    photoDiv.appendChild(img);
                                    summary.appendChild(photoDiv);
                                }
        
                                if (comment) {
                                    const commentDiv = document.createElement('div');
                                    commentDiv.classList.add('comment-preview');
                                    commentDiv.innerHTML = `<i class="fas fa-quote-left"></i> ${comment.length > 50 ? comment.substring(0, 50) + '...' : comment}`;
                                    summary.appendChild(commentDiv);
                                }
        
                                // Remove "no completion" message if present
                                const noCompletion = card.querySelector('.completion-summary.no-completion');
                                if (noCompletion) {
                                    noCompletion.remove();
                                }
        
                                // Update the edit button text/icon
                                const btnEdit = card.querySelector('.btn-edit');
                                if (btnEdit) {
                                    btnEdit.innerHTML = '<i class="fas fa-edit"></i> Editar';
                                }
                            }
        
                            // Atualizar a seção de progresso
                            updateProgressUI(data.completed_days, data.total_days);
        
                            // Reaplicar o filtro ativo
                            const activeFilter = document.querySelector('.filter-option.active');
                            if (activeFilter) {
                                activeFilter.click();
                            }
        
                            // Show a success flash message
                            showFlashMessage('Tarefa diária salva com sucesso!');
                        } else {
                            throw new Error('Resposta do servidor indica falha na conclusão');
                        }
                    })
                    .catch(error => {
                        console.error('Erro na requisição:', error);
                        showFlashMessage('Erro ao salvar a tarefa diária. Tente novamente.', true);
                    });
                });
            }
        
            // Restore view and filter buttons functionality
            const viewOptions = document.querySelectorAll('.view-option');
            const filterOptions = document.querySelectorAll('.filter-option');
            const timelineGrid = document.querySelector('.timeline-grid');
        
            viewOptions.forEach(option => {
                option.addEventListener('click', function() {
                    viewOptions.forEach(opt => opt.classList.remove('active'));
                    this.classList.add('active');
        
                    const view = this.dataset.view;
                    if (timelineGrid) {
                        timelineGrid.className = 'timeline-' + view;
                    }
                });
            });
        
            filterOptions.forEach(option => {
                option.addEventListener('click', function() {
                    filterOptions.forEach(opt => opt.classList.remove('active'));
                    this.classList.add('active');
        
                    const filter = this.dataset.filter;
                    if (timelineGrid) {
                        timelineGrid.classList.remove('filter-all', 'filter-completed', 'filter-missing');
                        timelineGrid.classList.add('filter-' + filter);
                    }
                });
            });
            
            // Função para aplicar os dados das conclusões aos cards
            function applyCompletionsToCards() {
                for (const date in completionsData) {
                    const completion = completionsData[date];
                    if (completion.completed) {
                        const card = document.querySelector(`.daily-card[data-date="${date}"]`);
                        if (card) {
                            // Marca o card como concluído
                            card.classList.remove('missing');
                            card.classList.add('completed');
                            
                            // Adiciona o badge de conclusão se não existir
                            let badge = card.querySelector('.completion-badge');
                            if (!badge) {
                                badge = document.createElement('div');
                                badge.classList.add('completion-badge');
                                badge.innerHTML = '<i class="fas fa-check-circle"></i>';
                                const dayHeader = card.querySelector('.day-header');
                                if (dayHeader) {
                                    dayHeader.appendChild(badge);
                                }
                            }
                            
                            // Atualiza o resumo da conclusão
                            let summary = card.querySelector('.completion-summary');
                            if (!summary) {
                                summary = document.createElement('div');
                                summary.classList.add('completion-summary');
                                card.insertBefore(summary, card.querySelector('.btn-edit'));
                            } else {
                                // Limpa o conteúdo atual
                                summary.innerHTML = '';
                                summary.classList.remove('no-completion');
                            }
                            
                            if (completion.photo_url) {
                                const photoDiv = document.createElement('div');
                                photoDiv.classList.add('photo-preview');
                                const img = document.createElement('img');
                                img.src = completion.photo_url;
                                img.alt = `Foto do dia ${card.querySelector('.day-number').textContent}`;
                                img.classList.add('daily-photo-thumb');
                                photoDiv.appendChild(img);
                                summary.appendChild(photoDiv);
                            }
                            
                            if (completion.comment) {
                                const commentDiv = document.createElement('div');
                                commentDiv.classList.add('comment-preview');
                                commentDiv.innerHTML = `<i class="fas fa-quote-left"></i> ${completion.comment.length > 50 ? completion.comment.substring(0, 50) + '...' : completion.comment}`;
                                summary.appendChild(commentDiv);
                            }
                            
                            // Atualiza o botão de edição
                            const btnEdit = card.querySelector('.btn-edit');
                            if (btnEdit) {
                                btnEdit.innerHTML = '<i class="fas fa-edit"></i> Editar';
                            }
                        }
                    }
                }
            }
            
            // Aplica os dados de conclusão após o carregamento da página
            applyCompletionsToCards();
            
            // Adiciona ouvintes para os botões de fechamento das mensagens flash
            document.querySelectorAll('.close-flash').forEach(button => {
                button.addEventListener('click', function() {
                    this.closest('.flash-message').remove();
                });
            });
        });
    </script>
</body>
</html>